/*!
 * NeepRouter v0.1.0-alpha.4
 * (c) 2020 Fierflame
 * @license MIT
 */
import{mSimple as t,mName as e}from"@neep/core";function r(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}let i,n,o,s,a,h,u,c,l;function f(t){const e=t.delivered(l);if(!e)return;const{router:r,depth:i}=e;Reflect.defineProperty(t,"route",{value:r,enumerable:!0,configurable:!0}),Reflect.defineProperty(t,"match",{get:()=>null==r?void 0:r._get(i),enumerable:!0,configurable:!0})}function p(t,{delivered:e}){const r=t.router instanceof I,i=e(l),n=r?t.router:null==i?void 0:i.router;if(!(n instanceof I))return;let o=t.depth;if("number"==typeof o&&Number.isInteger(o)?o<0&&(o=n.size-o):o=r?0:((null==i?void 0:i.depth)||0)+1,o<0)return null;const s=n._get(o);if(!s)return;const{route:{components:u}}=s;if(!u)return null;const c=t.name||"default",f=c in u?u[c]:void 0;return f?(a(`[path=${s.path}]`,"#987654"),h(l,{value:{depth:o,router:n}},h(f,t))):null}function d(t,e){var r;const{route:i,childNodes:n}=e;if(!i)return h("template",{},...n);let{to:o,append:s,replace:a,path:u,search:c,hash:l,query:f,alias:p,params:d}=t;function v(){i&&o&&(a?i.replace(o):i.push(o))}return o?"string"==typeof o&&(o={path:o}):o={path:u,search:c,hash:l,query:f,alias:p,params:d},s&&(o.append=!0),(null===(r=i.history)||void 0===r?void 0:r.link({...t,to:o},e,v))||h("span",{"@click":v},...n)}t(p),e("RouterView",p),t(d),e("RouterLink",d);var v=[function(){o("RouterView",p),o("router-view",p),o("RouterLink",d),o("router-link",d)},function(){c(f)},function(){l=u()}];function y(t){!function(t){({value:i,encase:n,register:o,Error:s,label:a,createElement:h,createDeliver:u,addContextConstructor:c}=t)}(t);for(const t of v)t()}function m(t){for(t=("/"+t).replace(/\/+(\/|$)/g,"$1");/[^/]+\/\.{2,}(\/|$)/.test(t);)t=t.replace(/\/[^/]+\/\.(\.+(?:\/|$))/g,"/$1");return(t=t.replace(/\/\.+(\/|$)/g,"$1"))||"/"}function g(t,e){void 0===e&&(e={});for(var r=function(t){for(var e=[],r=0;r<t.length;){var i=t[r];if("*"!==i&&"+"!==i&&"?"!==i)if("\\"!==i)if("{"!==i)if("}"!==i)if(":"!==i)if("("!==i)e.push({type:"CHAR",index:r,value:t[r++]});else{var n=1,o="";if("?"===t[a=r+1])throw new TypeError('Pattern cannot start with "?" at '+a);for(;a<t.length;)if("\\"!==t[a]){if(")"===t[a]){if(0===--n){a++;break}}else if("("===t[a]&&(n++,"?"!==t[a+1]))throw new TypeError("Capturing groups are not allowed at "+a);o+=t[a++]}else o+=t[a++]+t[a++];if(n)throw new TypeError("Unbalanced pattern at "+r);if(!o)throw new TypeError("Missing pattern at "+r);e.push({type:"PATTERN",index:r,value:o}),r=a}else{for(var s="",a=r+1;a<t.length;){var h=t.charCodeAt(a);if(!(h>=48&&h<=57||h>=65&&h<=90||h>=97&&h<=122||95===h))break;s+=t[a++]}if(!s)throw new TypeError("Missing parameter name at "+r);e.push({type:"NAME",index:r,value:s}),r=a}else e.push({type:"CLOSE",index:r,value:t[r++]});else e.push({type:"OPEN",index:r,value:t[r++]});else e.push({type:"ESCAPED_CHAR",index:r++,value:t[r++]});else e.push({type:"MODIFIER",index:r,value:t[r++]})}return e.push({type:"END",index:r,value:""}),e}(t),i=e.prefixes,n=void 0===i?"./":i,o="[^"+b(e.delimiter||"/#?")+"]+?",s=[],a=0,h=0,u="",c=function(t){if(h<r.length&&r[h].type===t)return r[h++].value},l=function(t){var e=c(t);if(void 0!==e)return e;var i=r[h],n=i.type,o=i.index;throw new TypeError("Unexpected "+n+" at "+o+", expected "+t)},f=function(){for(var t,e="";t=c("CHAR")||c("ESCAPED_CHAR");)e+=t;return e};h<r.length;){var p=c("CHAR"),d=c("NAME"),v=c("PATTERN");if(d||v){var y=p||"";-1===n.indexOf(y)&&(u+=y,y=""),u&&(s.push(u),u=""),s.push({name:d||a++,prefix:y,suffix:"",pattern:v||o,modifier:c("MODIFIER")||""})}else{var m=p||c("ESCAPED_CHAR");if(m)u+=m;else if(u&&(s.push(u),u=""),c("OPEN")){y=f();var g=c("NAME")||"",_=c("PATTERN")||"",x=f();l("CLOSE"),s.push({name:g||(_?a++:""),pattern:g&&!_?o:_,prefix:y,suffix:x,modifier:c("MODIFIER")||""})}else l("END")}}return s}function _(t,e){return function(t,e){void 0===e&&(e={});var r=w(e),i=e.encode,n=void 0===i?function(t){return t}:i,o=e.validate,s=void 0===o||o,a=t.map((function(t){if("object"==typeof t)return new RegExp("^(?:"+t.pattern+")$",r)}));return function(e){for(var r="",i=0;i<t.length;i++){var o=t[i];if("string"!=typeof o){var h=e?e[o.name]:void 0,u="?"===o.modifier||"*"===o.modifier,c="*"===o.modifier||"+"===o.modifier;if(Array.isArray(h)){if(!c)throw new TypeError('Expected "'+o.name+'" to not repeat, but got an array');if(0===h.length){if(u)continue;throw new TypeError('Expected "'+o.name+'" to not be empty')}for(var l=0;l<h.length;l++){var f=n(h[l],o);if(s&&!a[i].test(f))throw new TypeError('Expected all "'+o.name+'" to match "'+o.pattern+'", but got "'+f+'"');r+=o.prefix+f+o.suffix}}else if("string"!=typeof h&&"number"!=typeof h){if(!u){var p=c?"an array":"a string";throw new TypeError('Expected "'+o.name+'" to be '+p)}}else{f=n(String(h),o);if(s&&!a[i].test(f))throw new TypeError('Expected "'+o.name+'" to match "'+o.pattern+'", but got "'+f+'"');r+=o.prefix+f+o.suffix}}else r+=o}return r}}(g(t,e),e)}function x(t,e){var r=[];return function(t,e,r){void 0===r&&(r={});var i=r.decode,n=void 0===i?function(t){return t}:i;return function(r){var i=t.exec(r);if(!i)return!1;for(var o=i[0],s=i.index,a=Object.create(null),h=function(t){if(void 0===i[t])return"continue";var r=e[t-1];"*"===r.modifier||"+"===r.modifier?a[r.name]=i[t].split(r.prefix+r.suffix).map((function(t){return n(t,r)})):a[r.name]=n(i[t],r)},u=1;u<i.length;u++)h(u);return{path:o,index:s,params:a}}}(E(t,r,e),r,e)}function b(t){return t.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function w(t){return t&&t.sensitive?"":"i"}function $(t,e,r){return function(t,e,r){void 0===r&&(r={});for(var i=r.strict,n=void 0!==i&&i,o=r.start,s=void 0===o||o,a=r.end,h=void 0===a||a,u=r.encode,c=void 0===u?function(t){return t}:u,l="["+b(r.endsWith||"")+"]|$",f="["+b(r.delimiter||"/#?")+"]",p=s?"^":"",d=0,v=t;d<v.length;d++){var y=v[d];if("string"==typeof y)p+=b(c(y));else{var m=b(c(y.prefix)),g=b(c(y.suffix));if(y.pattern)if(e&&e.push(y),m||g)if("+"===y.modifier||"*"===y.modifier){var _="*"===y.modifier?"?":"";p+="(?:"+m+"((?:"+y.pattern+")(?:"+g+m+"(?:"+y.pattern+"))*)"+g+")"+_}else p+="(?:"+m+"("+y.pattern+")"+g+")"+y.modifier;else p+="("+y.pattern+")"+y.modifier;else p+="(?:"+m+g+")"+y.modifier}}if(h)n||(p+=f+"?"),p+=r.endsWith?"(?="+l+")":"$";else{var x=t[t.length-1],$="string"==typeof x?f.indexOf(x[x.length-1])>-1:void 0===x;n||(p+="(?:"+f+"(?="+l+"))?"),$||(p+="(?="+f+"|"+l+")")}return new RegExp(p,w(r))}(g(t,r),e,r)}function E(t,e,r){return t instanceof RegExp?function(t,e){if(!e)return t;for(var r=/\((?:\?<(.*?)>)?(?!\?)/g,i=0,n=r.exec(t.source);n;)e.push({name:n[1]||i++,prefix:"",suffix:"",modifier:"",pattern:""}),n=r.exec(t.source);return t}(t,e):Array.isArray(t)?function(t,e,r){var i=t.map((function(t){return E(t,e,r).source}));return new RegExp("(?:"+i.join("|")+")",w(r))}(t,e,r):$(t,e,r)}function*R(t,e=[]){for(const r of e){const e=r.match(t);if(e)return(r.components||r.redirect)&&(yield{...e,route:r}),void(r.redirect||(yield*R(t,r.children)))}}function k(t){if(void 0!==t){if(null===t)return null;if(!1!==t&&("number"!=typeof t||Number.isFinite(t))&&"function"!=typeof t)return encodeURIComponent(String(t))}}function A(t){const e=[];for(const r of Object.keys(t)){const i=t[r],n=encodeURIComponent(r);if(Array.isArray(i))for(const t of i){const r=k(t);void 0!==r&&e.push(null===r?n:`${n}=${r}`)}else{const t=k(i);if(void 0===t)continue;e.push(null===t?n:`${n}=${t}`)}}return e.join("&")}function P(t){const e=Object.create(null);function r(t,r=null){if(!(t in e))return void(e[t]=r);const i=e[t];Array.isArray(i)?i.push(r):e[t]=[i,r]}for(const e of t.split("&")){const t=e.indexOf("=");if(t<0){r(decodeURIComponent(e));continue}r(decodeURIComponent(e.substr(0,t)),decodeURIComponent(e.substr(t+1)))}return e}function C(t){const e=/^([^?#]*)((?:\?[^#]*)?)((?:#.*)?)$/.exec(t);return e?[e[1]||"/",e[2],e[3]]:["/","",""]}var O=Object.freeze({__proto__:null,Memory:class{constructor(t){r(this,"router",void 0),r(this,"index",0),r(this,"history",[]),this.router=t}push(t,e,r,i){this.history.length=this.index+1,this.index++,this.history.push([t,e,r,i])}replace(t,e,r,i){this.history[this.index]=[t,e,r,i]}go(t){let e=this.index+t;if(!(e>=this.history.length||e<0||e===this.index))return this.index=e,this.history[e]}back(){return this.go(-1)}forward(){return this.go(1)}link({id:t,class:e,style:r},{childNodes:i,emit:n},o){return h("span",{id:t,class:e,style:r,"n-on":n.omit("click"),"@click":(...t)=>{n("click",...t)&&o()}},...i)}},WebPath:class{constructor(t,e){r(this,"router",void 0),r(this,"base",void 0),this.router=t;let i=m((null==e?void 0:e.base)||"");this.base="/"===i?"":i;const n=()=>{this.router._update(this.getPath(),location.search,location.hash,history.state)};window.addEventListener("popstate",n),this.destroy=()=>{this.destroy=()=>{},window.removeEventListener("popstate",n)}}start(){this.router._update(this.getPath(),location.search,location.hash,history.state)}destroy(){}push(t,e,r,i){history.pushState(i,"",`${this.base}${t}${e}${r}`)}replace(t,e,r,i){history.replaceState(i,"",`${this.base}${t}${e}${r}`)}getPath(){const t=location.pathname,{base:e}=this;return e?0!==t.indexOf(e+"/")?t:t.substr(e.length):t}go(t){const e=this.getPath(),r=location.search,i=location.hash,n=history.state;history.go(t);const o=this.getPath(),s=location.search,a=location.hash,h=history.state;if(o!==e||s!==r||a!==i||h!==n)return[o,s,a,h]}back(){return this.go(-1)}forward(){return this.go(1)}link({to:t,onclick:e,id:r,class:i,style:n},{childNodes:o,emit:s},a){return h("a",{id:r,class:i,style:n,href:`${this.base}${this.router.getUrl(t)}`,"n-on":s.omit("click"),"@click":t=>{let r=!s("click",t);"function"==typeof e&&e(t),t.defaultPrevented||(t.preventDefault(),r||a())}},...o)}},WebHash:class{constructor(t){r(this,"router",void 0),this.router=t;const e=()=>{const[t,e,r]=C(location.hash.substr(1));this.router._update(t,e,r)};window.addEventListener("hashchange",e),this.destroy=()=>{this.destroy=()=>{},window.removeEventListener("hashchange",e)}}start(){const[t,e,r]=C(location.hash.substr(1));this.router._update(t,e,r)}destroy(){}push(t,e,r){location.hash=`#${t}${e}${r}`}replace(t,e,r){location.replace(`#${t}${e}${r}`)}go(t){const e=location.hash;history.go(t);const r=location.hash;if(r!==e)return[...C(r.substr(1)),void 0]}back(){return this.go(-1)}forward(){return this.go(1)}link({to:t,onclick:e,id:r,class:i,style:n},{childNodes:o,emit:s},a){return h("a",{id:r,class:i,style:n,href:"#"+this.router.getUrl(t),"n-on":s.omit("click"),"@click":t=>{let r=!s("click",t);"function"==typeof e&&e(t),t.defaultPrevented||(t.preventDefault(),r||a())}},...o)}}});function T(t,e,r,i=A){"string"==typeof t&&(t={path:t});const n=t.alias&&e[t.alias],o=t.path&&/^([^?#]*)((?:\?[^#]*)?)((?:#.*)?)$/.exec(t.path);let s=(null==o?void 0:o[1])||"";if(s)if(n){let e=n.toPath(t.params||{});t.append||(e=e.replace(/\/[^/]*\/?$/,"")),s=`${n.toPath(t.params||{})}/${s}`}else t.append&&(s=`${r}/${s}`);else s=n?n.toPath(t.params||{}):r;"/"!==s[0]&&(s=`${r.replace(/\/[^/]*\/?$/,"")}/${s}`),s=m(s);return{path:s,search:t.query&&"?"+i(t.query)||t.search||(null==o?void 0:o[2])||"",hash:t.hash||(null==o?void 0:o[3])||""}}function N(t,e={}){const r=new Set(Reflect.ownKeys(e));for(const e of Reflect.ownKeys(t))r.has(e)||delete t[e];for(const i of r)t[i]=e[i];return t}const j=[];class I{static get history(){return O}static get install(){return y}static get View(){return p}static get Link(){return d}get size(){return this._size()}get matches(){return this._matches()}get alias(){return this._alias()}get path(){return this._path()}get search(){return this._search()}get hash(){return this._hash()}get state(){return this._state()}constructor({History:t,historyOption:e}){if(r(this,"_namedRoutes",Object.create(null)),r(this,"_routes",[]),r(this,"history",void 0),r(this,"_size",i(0)),r(this,"_nodes",[]),r(this,"_matches",i([])),r(this,"_hash",i("")),r(this,"_search",i("")),r(this,"_alias",i("")),r(this,"_path",i("/")),r(this,"_state",i(void 0)),r(this,"params",n(Object.create(null))),r(this,"query",n(Object.create(null))),r(this,"meta",n(Object.create(null))),t){var o;const r=new t(this,e);this.history=r,null===(o=r.start)||void 0===o||o.call(r)}}setRoutes(t){const e=Object.create(null);this._routes=t.map(t=>function t(e,r,i){let{path:n,children:o,alias:s,meta:a,component:h,components:u,...c}=e,l=!(Array.isArray(o)&&o.length);n&&"*"!==n||(n="",l=!1),"/"!==n[0]&&(n=`${(null==i?void 0:i.path)||""}/${n}`),n=m(n),h&&(u||(u={}),u.default=h);const f={...c,path:n,alias:s,component:h,components:u,meta:a||{},toPath:_(n||"",{encode:encodeURIComponent}),match:x(n||"",{end:l,decode:decodeURIComponent})};return s&&(r[s]=f),Array.isArray(o)&&(f.children=o.map(e=>t(e,r,f))),f}(t,e)),this._namedRoutes=e,this._update(this._path(),this._search(),this._hash(),this._state(),!0)}_get(t){var e,r;const i=null===(e=(r=this._nodes)[t])||void 0===e?void 0:e.call(r);if(i)return i;this._size()}_update(t,e,r,n,o=!1){if(this._path()!==t||o){var a,h;const e=[...R(t,this._routes)],r=e[e.length-1];if(r&&!r.route.components){if(j.push(t),j.length>=10)throw new s("Too many consecutive redirect jumps: \n"+j.join("\n"),"router");const{redirect:e,append:i}=r.route;try{return void(i?this.replace(`${t}/${e}`,n):e&&"/"===e[0]?this.replace(e,n):this.replace(`${t}/../${e}`,n))}finally{j.pop()}}const o=this._nodes,u=o.length,c=e.length,l=Math.min(c,u);for(let t=0;t<l;t++)o[t](e[t]);for(let t=l;t<u;t++)o[t](void 0);for(let t=l;t<c;t++)o[t]=i(e[t]);o.length=c,this._size(c),this._matches(e),this._path(t),this._alias((null==r||null===(a=r.route)||void 0===a?void 0:a.alias)||""),N(this.params,(null==r?void 0:r.params)||{}),N(this.meta,(null==r||null===(h=r.route)||void 0===h?void 0:h.meta)||{})}this._search()!==e&&(this._search(e),N(this.query,(this.parse||P)(e.substr(1)))),this._hash(r),this._state(n)}push(t,e){var r;const{path:i,search:n,hash:o}=T(t,this._namedRoutes,this._path(),this.stringify);null===(r=this.history)||void 0===r||r.push(i,n,o,e),this._update(i,n,o,e)}replace(t,e){var r;const{path:i,search:n,hash:o}=T(t,this._namedRoutes,this._path(),this.stringify);null===(r=this.history)||void 0===r||r.replace(i,n,o,e),this._update(i,n,o,e)}getUrl(t){const{path:e,search:r,hash:i}=T(t,this._namedRoutes,this._path(),this.stringify);return`${e}${r}${i}`}go(t){var e;const r=null===(e=this.history)||void 0===e?void 0:e.go(t);r&&this._update(...r)}back(){var t;const e=null===(t=this.history)||void 0===t?void 0:t.back();e&&this._update(...e)}forward(){var t;const e=null===(t=this.history)||void 0===t?void 0:t.forward();e&&this._update(...e)}get view(){const r=(t,...e)=>p({...t,router:this},...e);return e("Router",r),t(r),Reflect.defineProperty(this,"view",{value:r,enumerable:!0,configurable:!0}),r}}export default I;export{d as RouterLink,p as RouterView,O as history,y as install};
