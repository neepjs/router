/*!
 * NeepRouter v0.1.0-alpha.2
 * (c) 2020 Fierflame
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@neep/core")):"function"==typeof define&&define.amd?define(["@neep/core"],t):(e=e||self).NeepRouter=t(e.Neep)}(this,(function(e){"use strict";function t(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function r(e){const t=e.delivered.__NeepRouter__,r=e.delivered.__RouteDepth__||0;Reflect.defineProperty(e,"route",{value:t,enumerable:!0,configurable:!0}),Reflect.defineProperty(e,"match",{get:()=>null==t?void 0:t._get(r),enumerable:!0,configurable:!0})}function i(e,{delivered:t},{createElement:r,Deliver:i,label:n}){const o=e.router instanceof $,s=o?e.router:t.__NeepRouter__;if(!(s instanceof $))return;let a=e.depth;if("number"==typeof a&&Number.isInteger(a)?a<0&&(a=s.size-a):a=o?0:(t.__RouteDepth__||0)+1,a<0)return null;const h=s._get(a);if(!h)return;const{route:{components:u}}=h;if(!u)return null;const c=e.name||"default",l=c in u?u[c]:void 0;return l?(n(`[path=${h.path}]`,"#987654"),r(i,{__RouteDepth__:a,__NeepRouter__:s},r(l,e))):null}function n(e,t,r){var i;const{route:n,childNodes:o}=t,{createElement:s}=r;if(!n)return s("template",{},...o);let{to:a,append:h,replace:u,path:c,search:l,hash:f,query:p,alias:d,params:v}=e;function m(){n&&a&&(u?n.replace(a):n.push(a))}return a?"string"==typeof a&&(a={path:a}):a={path:c,search:l,hash:f,query:p,alias:d,params:v},h&&(a.append=!0),(null===(i=n.history)||void 0===i?void 0:i.link({...e,to:a},t,r,m))||s("span",{"@click":m},...o)}function o(e){}function s(e){for(e=("/"+e).replace(/\/+(\/|$)/g,"$1");/[^/]+\/\.{2,}(\/|$)/.test(e);)e=e.replace(/\/[^/]+\/\.(\.+(?:\/|$))/g,"/$1");return(e=e.replace(/\/\.+(\/|$)/g,"$1"))||"/"}function a(e,t){void 0===t&&(t={});for(var r=function(e){for(var t=[],r=0;r<e.length;){var i=e[r];if("*"!==i&&"+"!==i&&"?"!==i)if("\\"!==i)if("{"!==i)if("}"!==i)if(":"!==i)if("("!==i)t.push({type:"CHAR",index:r,value:e[r++]});else{var n=1,o="";if("?"===e[a=r+1])throw new TypeError('Pattern cannot start with "?" at '+a);for(;a<e.length;)if("\\"!==e[a]){if(")"===e[a]){if(0===--n){a++;break}}else if("("===e[a]&&(n++,"?"!==e[a+1]))throw new TypeError("Capturing groups are not allowed at "+a);o+=e[a++]}else o+=e[a++]+e[a++];if(n)throw new TypeError("Unbalanced pattern at "+r);if(!o)throw new TypeError("Missing pattern at "+r);t.push({type:"PATTERN",index:r,value:o}),r=a}else{for(var s="",a=r+1;a<e.length;){var h=e.charCodeAt(a);if(!(h>=48&&h<=57||h>=65&&h<=90||h>=97&&h<=122||95===h))break;s+=e[a++]}if(!s)throw new TypeError("Missing parameter name at "+r);t.push({type:"NAME",index:r,value:s}),r=a}else t.push({type:"CLOSE",index:r,value:e[r++]});else t.push({type:"OPEN",index:r,value:e[r++]});else t.push({type:"ESCAPED_CHAR",index:r++,value:e[r++]});else t.push({type:"MODIFIER",index:r,value:e[r++]})}return t.push({type:"END",index:r,value:""}),t}(e),i=t.prefixes,n=void 0===i?"./":i,o="[^"+c(t.delimiter||"/#?")+"]+?",s=[],a=0,h=0,u="",l=function(e){if(h<r.length&&r[h].type===e)return r[h++].value},f=function(e){var t=l(e);if(void 0!==t)return t;var i=r[h],n=i.type,o=i.index;throw new TypeError("Unexpected "+n+" at "+o+", expected "+e)},p=function(){for(var e,t="";e=l("CHAR")||l("ESCAPED_CHAR");)t+=e;return t};h<r.length;){var d=l("CHAR"),v=l("NAME"),m=l("PATTERN");if(v||m){var y=d||"";-1===n.indexOf(y)&&(u+=y,y=""),u&&(s.push(u),u=""),s.push({name:v||a++,prefix:y,suffix:"",pattern:m||o,modifier:l("MODIFIER")||""})}else{var g=d||l("ESCAPED_CHAR");if(g)u+=g;else if(u&&(s.push(u),u=""),l("OPEN")){y=p();var _=l("NAME")||"",b=l("PATTERN")||"",x=p();f("CLOSE"),s.push({name:_||(b?a++:""),pattern:_&&!b?o:b,prefix:y,suffix:x,modifier:l("MODIFIER")||""})}else f("END")}}return s}function h(e,t){return function(e,t){void 0===t&&(t={});var r=l(t),i=t.encode,n=void 0===i?function(e){return e}:i,o=t.validate,s=void 0===o||o,a=e.map((function(e){if("object"==typeof e)return new RegExp("^(?:"+e.pattern+")$",r)}));return function(t){for(var r="",i=0;i<e.length;i++){var o=e[i];if("string"!=typeof o){var h=t?t[o.name]:void 0,u="?"===o.modifier||"*"===o.modifier,c="*"===o.modifier||"+"===o.modifier;if(Array.isArray(h)){if(!c)throw new TypeError('Expected "'+o.name+'" to not repeat, but got an array');if(0===h.length){if(u)continue;throw new TypeError('Expected "'+o.name+'" to not be empty')}for(var l=0;l<h.length;l++){var f=n(h[l],o);if(s&&!a[i].test(f))throw new TypeError('Expected all "'+o.name+'" to match "'+o.pattern+'", but got "'+f+'"');r+=o.prefix+f+o.suffix}}else if("string"!=typeof h&&"number"!=typeof h){if(!u){var p=c?"an array":"a string";throw new TypeError('Expected "'+o.name+'" to be '+p)}}else{f=n(String(h),o);if(s&&!a[i].test(f))throw new TypeError('Expected "'+o.name+'" to match "'+o.pattern+'", but got "'+f+'"');r+=o.prefix+f+o.suffix}}else r+=o}return r}}(a(e,t),t)}function u(e,t){var r=[];return function(e,t,r){void 0===r&&(r={});var i=r.decode,n=void 0===i?function(e){return e}:i;return function(r){var i=e.exec(r);if(!i)return!1;for(var o=i[0],s=i.index,a=Object.create(null),h=function(e){if(void 0===i[e])return"continue";var r=t[e-1];"*"===r.modifier||"+"===r.modifier?a[r.name]=i[e].split(r.prefix+r.suffix).map((function(e){return n(e,r)})):a[r.name]=n(i[e],r)},u=1;u<i.length;u++)h(u);return{path:o,index:s,params:a}}}(p(e,r,t),r,t)}function c(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function l(e){return e&&e.sensitive?"":"i"}function f(e,t,r){return function(e,t,r){void 0===r&&(r={});for(var i=r.strict,n=void 0!==i&&i,o=r.start,s=void 0===o||o,a=r.end,h=void 0===a||a,u=r.encode,f=void 0===u?function(e){return e}:u,p="["+c(r.endsWith||"")+"]|$",d="["+c(r.delimiter||"/#?")+"]",v=s?"^":"",m=0,y=e;m<y.length;m++){var g=y[m];if("string"==typeof g)v+=c(f(g));else{var _=c(f(g.prefix)),b=c(f(g.suffix));if(g.pattern)if(t&&t.push(g),_||b)if("+"===g.modifier||"*"===g.modifier){var x="*"===g.modifier?"?":"";v+="(?:"+_+"((?:"+g.pattern+")(?:"+b+_+"(?:"+g.pattern+"))*)"+b+")"+x}else v+="(?:"+_+"("+g.pattern+")"+b+")"+g.modifier;else v+="("+g.pattern+")"+g.modifier;else v+="(?:"+_+b+")"+g.modifier}}if(h)n||(v+=d+"?"),v+=r.endsWith?"(?="+p+")":"$";else{var w=e[e.length-1],$="string"==typeof w?d.indexOf(w[w.length-1])>-1:void 0===w;n||(v+="(?:"+d+"(?="+p+"))?"),$||(v+="(?="+d+"|"+p+")")}return new RegExp(v,l(r))}(a(e,r),t,r)}function p(e,t,r){return e instanceof RegExp?function(e,t){if(!t)return e;var r=e.source.match(/\((?!\?)/g);if(r)for(var i=0;i<r.length;i++)t.push({name:i,prefix:"",suffix:"",modifier:"",pattern:""});return e}(e,t):Array.isArray(e)?function(e,t,r){var i=e.map((function(e){return p(e,t,r).source}));return new RegExp("(?:"+i.join("|")+")",l(r))}(e,t,r):f(e,t,r)}function*d(e,t=[]){for(const r of t){const t=r.match(e);if(t)return(r.components||r.redirect)&&(yield{...t,route:r}),void(r.redirect||(yield*d(e,r.children)))}}function v(e){if(void 0!==e){if(null===e)return null;if(!1!==e&&("number"!=typeof e||Number.isFinite(e))&&"function"!=typeof e)return encodeURIComponent(String(e))}}function m(e){const t=[];for(const r of Object.keys(e)){const i=e[r],n=encodeURIComponent(r);if(Array.isArray(i))for(const e of i){const r=v(e);void 0!==r&&t.push(null===r?n:`${n}=${r}`)}else{const e=v(i);if(void 0===e)continue;t.push(null===e?n:`${n}=${e}`)}}return t.join("&")}function y(e){const t=Object.create(null);function r(e,r=null){if(!(e in t))return void(t[e]=r);const i=t[e];Array.isArray(i)?i.push(r):t[e]=[i,r]}for(const t of e.split("&")){const e=t.indexOf("=");e<0?r(decodeURIComponent(t)):r(decodeURIComponent(t.substr(0,e)),decodeURIComponent(t.substr(e+1)))}return t}e.mSimple(i),e.mName("RouterView",i),e.mSimple(n),e.mName("RouterLink",n),e.register("RouterView",i),e.register("router-view",i),e.register("RouterLink",n),e.register("router-link",n),e.addContextConstructor(r);function g(e){const t=/^([^?#]*)((?:\?[^#]*)?)((?:#.*)?)$/.exec(e);return t?[t[1]||"/",t[2],t[3]]:["/","",""]}var _=Object.freeze({__proto__:null,Memory:class{constructor(e){t(this,"router",void 0),t(this,"index",0),t(this,"history",[]),this.router=e}push(e,t,r,i){this.history.length=this.index+1,this.index++,this.history.push([e,t,r,i])}replace(e,t,r,i){this.history[this.index]=[e,t,r,i]}go(e){let t=this.index+e;if(!(t>=this.history.length||t<0||t===this.index))return this.index=t,this.history[t]}back(){return this.go(-1)}forward(){return this.go(1)}link({id:e,class:t,style:r},{childNodes:i,emit:n},{createElement:o},s){return o("span",{id:e,class:t,style:r,"n-on":n.omit("click"),"@click":(...e)=>{n("click",...e)&&s()}},...i)}},WebPath:class{constructor(e,r){t(this,"router",void 0),t(this,"base",void 0),this.router=e;let i=s((null==r?void 0:r.base)||"");this.base="/"===i?"":i;const n=()=>{this.router._update(this.getPath(),location.search,location.hash,history.state)};window.addEventListener("popstate",n),this.destroy=()=>{this.destroy=()=>{},window.removeEventListener("popstate",n)}}start(){this.router._update(this.getPath(),location.search,location.hash,history.state)}destroy(){}push(e,t,r,i){history.pushState(i,"",`${this.base}${e}${t}${r}`)}replace(e,t,r,i){history.replaceState(i,"",`${this.base}${e}${t}${r}`)}getPath(){const e=location.pathname,{base:t}=this;return t?0!==e.indexOf(t+"/")?e:e.substr(t.length):e}go(e){const t=this.getPath(),r=location.search,i=location.hash,n=history.state;history.go(e);const o=this.getPath(),s=location.search,a=location.hash,h=history.state;if(o!==t||s!==r||a!==i||h!==n)return[o,s,a,h]}back(){return this.go(-1)}forward(){return this.go(1)}link({to:e,onclick:t,id:r,class:i,style:n},{childNodes:o,emit:s},{createElement:a},h){return a("a",{id:r,class:i,style:n,href:`${this.base}${this.router.getUrl(e)}`,"n-on":s.omit("click"),"@click":e=>{let r=!s("click",e);"function"==typeof t&&t(e),e.defaultPrevented||(e.preventDefault(),r||h())}},...o)}},WebHash:class{constructor(e){t(this,"router",void 0),this.router=e;const r=()=>{const[e,t,r]=g(location.hash.substr(1));this.router._update(e,t,r)};window.addEventListener("hashchange",r),this.destroy=()=>{this.destroy=()=>{},window.removeEventListener("hashchange",r)}}start(){const[e,t,r]=g(location.hash.substr(1));this.router._update(e,t,r)}destroy(){}push(e,t,r){location.hash=`#${e}${t}${r}`}replace(e,t,r){location.replace(`#${e}${t}${r}`)}go(e){const t=location.hash;history.go(e);const r=location.hash;if(r!==t)return[...g(r.substr(1)),void 0]}back(){return this.go(-1)}forward(){return this.go(1)}link({to:e,onclick:t,id:r,class:i,style:n},{childNodes:o,emit:s},{createElement:a},h){return a("a",{id:r,class:i,style:n,href:"#"+this.router.getUrl(e),"n-on":s.omit("click"),"@click":e=>{let r=!s("click",e);"function"==typeof t&&t(e),e.defaultPrevented||(e.preventDefault(),r||h())}},...o)}}});function b(e,t,r,i=m){"string"==typeof e&&(e={path:e});const n=e.alias&&t[e.alias],o=e.path&&/^([^?#]*)((?:\?[^#]*)?)((?:#.*)?)$/.exec(e.path);let a=(null==o?void 0:o[1])||"";if(a)if(n){let t=n.toPath(e.params||{});e.append||(t=t.replace(/\/[^/]*\/?$/,"")),a=`${n.toPath(e.params||{})}/${a}`}else e.append&&(a=`${r}/${a}`);else a=n?n.toPath(e.params||{}):r;return"/"!==a[0]&&(a=`${r.replace(/\/[^/]*\/?$/,"")}/${a}`),a=s(a),{path:a,search:e.query&&"?"+i(e.query)||e.search||(null==o?void 0:o[2])||"",hash:e.hash||(null==o?void 0:o[3])||""}}function x(e,t={}){const r=new Set(Reflect.ownKeys(t));for(const t of Reflect.ownKeys(e))r.has(t)||delete e[t];for(const i of r)e[i]=t[i];return e}const w=[];class ${static get history(){return _}static get install(){return o}static get View(){return i}static get Link(){return n}get size(){return this._size()}get matches(){return this._matches()}get alias(){return this._alias()}get path(){return this._path()}get search(){return this._search()}get hash(){return this._hash()}get state(){return this._state()}constructor({History:r,historyOption:i}){if(t(this,"_namedRoutes",Object.create(null)),t(this,"_routes",[]),t(this,"history",void 0),t(this,"_size",e.value(0)),t(this,"_nodes",[]),t(this,"_matches",e.value([])),t(this,"_hash",e.value("")),t(this,"_search",e.value("")),t(this,"_alias",e.value("")),t(this,"_path",e.value("/")),t(this,"_state",e.value(void 0)),t(this,"params",e.encase(Object.create(null))),t(this,"query",e.encase(Object.create(null))),t(this,"meta",e.encase(Object.create(null))),r){var n;const e=new r(this,i);this.history=e,null===(n=e.start)||void 0===n||n.call(e)}}setRoutes(e){const t=Object.create(null);this._routes=e.map(e=>function e(t,r,i){let{path:n,children:o,alias:a,meta:c,component:l,components:f,...p}=t,d=!(Array.isArray(o)&&o.length);n&&"*"!==n||(n="",d=!1),"/"!==n[0]&&(n=`${(null==i?void 0:i.path)||""}/${n}`),n=s(n),l&&(f||(f={}),f.default=l);const v={...p,path:n,alias:a,component:l,components:f,meta:c||{},toPath:h(n||"",{encode:encodeURIComponent}),match:u(n||"",{end:d,decode:decodeURIComponent})};return a&&(r[a]=v),Array.isArray(o)&&(v.children=o.map(t=>e(t,r,v))),v}(e,t)),this._namedRoutes=t,this._update(this._path(),this._search(),this._hash(),this._state(),!0)}_get(e){var t,r;const i=null===(t=(r=this._nodes)[e])||void 0===t?void 0:t.call(r);if(i)return i;this._size()}_update(t,r,i,n,o=!1){if(this._path()!==t||o){var s,a;const r=[...d(t,this._routes)],i=r[r.length-1];if(i&&!i.route.components){if(w.push(t),w.length>=10)throw new e.Error("Too many consecutive redirect jumps: \n"+w.join("\n"),"router");const{redirect:r,append:o}=i.route;try{return void(o?this.replace(`${t}/${r}`,n):r&&"/"===r[0]?this.replace(r,n):this.replace(`${t}/../${r}`,n))}finally{w.pop()}}const o=this._nodes,h=o.length,u=r.length,c=Math.min(u,h);for(let e=0;e<c;e++)o[e](r[e]);for(let e=c;e<h;e++)o[e](void 0);for(let t=c;t<u;t++)o[t]=e.value(r[t]);o.length=u,this._size(u),this._matches(r),this._path(t),this._alias((null==i||null===(s=i.route)||void 0===s?void 0:s.alias)||""),x(this.params,(null==i?void 0:i.params)||{}),x(this.meta,(null==i||null===(a=i.route)||void 0===a?void 0:a.meta)||{})}this._search()!==r&&(this._search(r),x(this.query,(this.parse||y)(r.substr(1)))),this._hash(i),this._state(n)}push(e,t){var r;const{path:i,search:n,hash:o}=b(e,this._namedRoutes,this._path(),this.stringify);null===(r=this.history)||void 0===r||r.push(i,n,o,t),this._update(i,n,o,t)}replace(e,t){var r;const{path:i,search:n,hash:o}=b(e,this._namedRoutes,this._path(),this.stringify);null===(r=this.history)||void 0===r||r.replace(i,n,o,t),this._update(i,n,o,t)}getUrl(e){const{path:t,search:r,hash:i}=b(e,this._namedRoutes,this._path(),this.stringify);return`${t}${r}${i}`}go(e){var t;const r=null===(t=this.history)||void 0===t?void 0:t.go(e);r&&this._update(...r)}back(){var e;const t=null===(e=this.history)||void 0===e?void 0:e.back();t&&this._update(...t)}forward(){var e;const t=null===(e=this.history)||void 0===e?void 0:e.forward();t&&this._update(...t)}get view(){const t=(e,...t)=>i({...e,router:this},...t);return e.mName("Router",t),Reflect.defineProperty(this,"view",{value:t,enumerable:!0,configurable:!0}),t}}return $}));
